---
layout: post
title: php生命周期2
date: 2019-09-11
categories: test
tags: PHP

---

# php生命周期2

Php有两种运行模式，WEB模式和CLI（命令行）模式。当我们在终端敲入php这个命令的时候，使用的是CLI模式；当使用Nginx或者别web服务器作为宿主处理一个到来的请求时，会调用Php运行，此时使用的是WEB模式。当我们请求一个Php文件时，比如Laravel 的`public\index.php`文件时，Php 为了完成这次请求，会发生5个阶段的生命周期切换：

1. 模块初始化（MINIT），即调用`php.ini`中指明的扩展的初始化函数进行初始化工作，如`mysql`扩展。
2. 请求初始化（RINIT），即初始化为执行本次脚本所需要的变量名称和变量值内容的符号表，如`$_SESSION`变量。
3. 执行该PHP脚本。
4. 请求处理完成(Request Shutdown)，按顺序调用各个模块的`RSHUTDOWN`方法，对每个变量调用`unset`函数，如unset `$_SESSION`变量。
5. 关闭模块(Module Shutdown) ， PHP调用每个扩展的`MSHUTDOWN`方法，这是各个模块最后一次释放内存的机会。这意味着没有下一个请求了。

WEB模式和CLI（命令行）模式很相似，区别是：CLI 模式会在每次脚本执行经历完整的5个周期，因为你脚本执行完不会有下一个请求；而WEB模式为了应对并发，可能采用多线程，因此生命周期`1`和`5`有可能只执行一次，下次请求到来时重复`2-4`的生命周期，这样就节省了系统模块初始化所带来的开销。

可以看到，Php生命周期是很对称的。说了这么多，就是为了定位Laravel运行在哪里，没错，Laravel仅仅运行再第三个阶段：

![file](http://px6xvo4m7.bkt.clouddn.com/2019-09-19_093634.png)

知道这些有什么用？你可以**优化**你的Laravel代码，可以更加**深入**的了解Larave的`singleton`（单例）。至少你知道了，每一次请求结束，Php的变量都会`unset`，Laravel的`singleton`只是在某一次请求过程中的`singleton`；你在Laravel 中的静态变量也不能在多个请求之间共享，因为每一次请求结束都会`unset`。理解这些概念，是写高质量代码的第一步，也是最关键的一步。因此记住，Php是一种脚本语言，所有的变量只会在这一次请求中生效，下次请求之时已被重置，而不像Java静态变量拥有全局作用。

